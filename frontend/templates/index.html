<!-- frontend/templates/index.html -->
{% extends "base.html" %}

{% block content %}
<div class="row g-3">
    <div class="col-12">
        <div class="hero card border-0 shadow-sm gradient-bg text-white mb-2">
            <div class="card-body d-flex align-items-center justify-content-between flex-wrap">
                <div class="mb-2">
                    <h3 class="mb-1">üìä Agentic AI Data Analyst</h3>
                    <p class="mb-0 opacity-75">Upload. Ask. Get visual insights and an autonomous report.</p>
                </div>
                {% if table_name %}
                <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-light text-dark">Table: {{ table_name }}</span>
                    <span class="badge bg-light text-dark">Rows: {{ df_sample.shape[0] }}</span>
                    <span class="badge bg-light text-dark">Cols: {{ df_sample.shape[1] }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100 shadow-sm sticky-controls">
            <div class="card-header bg-primary text-white d-flex align-items-center justify-content-between">
                <h5 class="mb-0">‚öôÔ∏è Controls</h5>
                <span class="small opacity-75">Step 1</span>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="files" class="form-label">üìÅ Upload Files</label>
                        <input type="file" class="form-control" id="files" name="files" multiple accept=".xlsx,.xls,.csv">
                        <div class="form-text">Max 50MB total</div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 mb-2" data-bs-toggle="tooltip" title="Load data and generate schema">Upload & Analyze</button>
                </form>
                {% if message %}
                <div class="alert alert-info shadow-sm">{{ message }}</div>
                {% endif %}
                <hr>
                {% if table_name %}
                <form method="post">
                    <button type="submit" name="generate_report" class="btn btn-info w-100 mb-2 trigger-loading" data-bs-toggle="tooltip" title="Create a full visual report">ü§ñ Generate Autonomous Report</button>
                    <button type="submit" name="reset_data" class="btn btn-warning w-100 mb-2" data-bs-toggle="tooltip" title="Clear current dataset and start fresh">üîÑ Reset Data</button>
                    <button type="submit" name="clear_memory" class="btn btn-secondary w-100" data-bs-toggle="tooltip" title="Clear conversation memory">üßπ Clear Memory</button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-9">
        {% if table_name %}
        <ul class="nav nav-tabs nav-fill mb-3 shadow-sm rounded" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if active_tab == 'preview' %}active{% endif %}" id="preview-tab" data-bs-toggle="tab" data-bs-target="#preview" type="button" role="tab">üìä Data Preview</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if active_tab == 'insights' %}active{% endif %}" id="insights-tab" data-bs-toggle="tab" data-bs-target="#insights" type="button" role="tab">üöÄ Autonomous Insights</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if active_tab == 'query' %}active{% endif %}" id="query-tab" data-bs-toggle="tab" data-bs-target="#query" type="button" role="tab">üí¨ Ask Analysis / Forecast</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if active_tab == 'report' %}active{% endif %}" id="report-tab" data-bs-toggle="tab" data-bs-target="#report" type="button" role="tab">üìÑ Full Autonomous Report</button>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade {% if active_tab == 'preview' %}show active{% endif %}" id="preview" role="tabpanel">
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Data Sample ({{ df_sample.shape[0] }} rows)</h5>
                        <span class="badge bg-secondary">Preview</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            {{ df_sample.to_html(classes='table table-striped mb-0', escape=False) | safe }}
                        </div>
                        <div class="card-footer">
                            <form method="post">
                                <button type="submit" name="download_sample" class="btn btn-success">üì• Download Sample Excel</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade {% if active_tab == 'insights' %}show active{% endif %}" id="insights" role="tabpanel">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">Autonomous Insights</h5>
                    </div>
                    <div class="card-body">
                        {% if insights.error %}
                        <div class="alert alert-warning">{{ insights.error }}</div>
                        {% else %}
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card bg-light border-0 shadow-sm">
                                    <div class="card-body text-center">
                                        <h6>Rows</h6>
                                        <h3 class="text-primary">{{ insights.shape[0] }}</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light border-0 shadow-sm">
                                    <div class="card-body text-center">
                                        <h6>Columns</h6>
                                        <h3 class="text-primary">{{ insights.shape[1] }}</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <h6>Data Types (Sample)</h6>
                        <div class="row">
                            {% for key, value in insights.sample_dtypes.items() %}
                            <div class="col-md-6 mb-2">
                                <small class="text-muted">{{ key }}: <span class="badge bg-secondary">{{ value }}</span></small>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        <div class="alert alert-success mt-3">‚úÖ Insights generated automatically.</div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade {% if active_tab == 'query' %}show active{% endif %}" id="query" role="tabpanel">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">Ask Your Data Question</h5>
                    </div>
                    <div class="card-body">
                        <form method="post">
                            <div class="mb-3">
                                <label for="query" class="form-label">Enter your analysis question (e.g., Monthly revenue of Paneer in Delhi) or "generate full report"</label>
                                <input type="text" class="form-control" id="query" name="query" placeholder="Type here..." value="{{ user_query or '' }}">
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary trigger-loading">üöÄ Analyze & Forecast</button>
                                <button type="submit" name="generate_viz" value="1" class="btn btn-outline-secondary">üìà Visualization</button>
                            </div>
                        </form>
                        {% if user_query %}
                        <hr class="my-4">
                        <h6>Results for: <em>"{{ user_query }}"</em></h6>
                        {% if df_result %}
                        <div class="table-responsive mb-3">
                            {{ df_result | safe }}
                        </div>
                        <div class="card-footer bg-light">
                            <form method="post">
                                <button type="submit" name="download_result" class="btn btn-success">üì• Download Results Excel</button>
                            </form>
                        </div>
                        {% endif %}
                        <div class="mt-3">
                            <h6>üìñ AI Explanation</h6>
                            <div class="alert alert-info">{{ explanation | safe }}</div>
                        </div>
                        {% if viz_b64 %}
                        <div class="mt-3">
                            <h6>üìà Visualization</h6>
                            <img src="data:image/png;base64,{{ viz_b64 }}" class="img-fluid rounded shadow" alt="Visualization">
                        </div>
                        {% endif %}
                        {% for title, b64 in chart_b64s %}
                        <div class="mt-3">
                            <h6>{{ title }}</h6>
                            <img src="data:image/png;base64,{{ b64 }}" class="img-fluid rounded shadow" alt="{{ title }}">
                        </div>
                        {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="tab-pane fade {% if active_tab == 'report' %}show active{% endif %}" id="report" role="tabpanel">
                {% if report_data %}
                <div class="accordion" id="reportAccordion">
                    {% for section in report_data %}
                    <div class="accordion-item shadow-sm mb-2 border-0">
                        <h2 class="accordion-header" id="heading{{ loop.index }}">
                            <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" aria-expanded="{% if loop.first %}true{% else %}false{% endif %}" aria-controls="collapse{{ loop.index }}">
                                {{ section.title }}
                            </button>
                        </h2>
                        <div id="collapse{{ loop.index }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}" aria-labelledby="heading{{ loop.index }}" data-bs-parent="#reportAccordion">
                            <div class="accordion-body">
                                <div class="alert alert-info">
                                    {{ section.explanation | safe }}
                                </div>
                                <div class="table-responsive mb-3">
                                    {{ section.df_html | safe }}
                                </div>
                                {% if section.viz_b64 %}
                                <div class="mb-3">
                                    <h6>üìà Visualization</h6>
                                    <img src="data:image/png;base64,{{ section.viz_b64 }}" class="img-fluid rounded shadow" alt="Visualization">
                                </div>
                                {% endif %}
                                {% for c_title, c_b64 in section.chart_b64s %}
                                <div class="mb-3">
                                    <h6>{{ c_title }}</h6>
                                    <img src="data:image/png;base64,{{ c_b64 }}" class="img-fluid rounded shadow" alt="{{ c_title }}">
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="alert alert-success mt-3">
                    ‚úÖ Full autonomous report generated! Each section adapts to your data schema.
                </div>
                <div class="card-footer bg-light mt-3">
                    <form method="post">
                        <button type="submit" name="download_report" class="btn btn-success">üì• Download Report (Word)</button>
                    </form>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <h5>üìÑ Autonomous Reports</h5>
                    <p>Click "Generate Autonomous Report" in controls to create a comprehensive analysis covering key business insights, trends, and forecasts.</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="alert alert-info mt-3">
            <h5>Welcome to üìä Agentic AI Data Analyst!</h5>
            <p><strong>Features:</strong></p>
            <ul>
                <li>Multi-file analysis & fusion (any Excel/CSV)</li>
                <li>AI-powered insights & explanations</li>
                <li>Natural language queries: monthly, quarterly, predictions</li>
                <li>Autonomous full reports: Generates 6-8 sections like performance, trends, summaries</li>
                <li>Charts, forecasts & Excel download</li>
                <li>Persistent memory for chained analysis</li>
            </ul>
            <p>Upload files to get started. Ask "generate full report" for autonomous analysis!</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Persist tab on client-side
document.addEventListener('DOMContentLoaded', function () {
    const activeTab = '{{ active_tab }}';
    if (activeTab === 'query') {
        new bootstrap.Tab(document.querySelector('#query-tab')).show();
    } else if (activeTab === 'insights') {
        new bootstrap.Tab(document.querySelector('#insights-tab')).show();
    } else if (activeTab === 'report') {
        new bootstrap.Tab(document.querySelector('#report-tab')).show();
    }
    // Enable tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    // Loading overlay on long actions
    const overlay = document.createElement('div');
    overlay.className = 'loading-overlay';
    overlay.innerHTML = '<div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div><div class="mt-2 text-white">Working on it...</div>';
    document.body.appendChild(overlay);
    function showOverlay() { overlay.classList.add('show'); }
    function hideOverlay() { overlay.classList.remove('show'); }
    // Ensure overlay is hidden on initial load
    hideOverlay();
    document.querySelectorAll('form .trigger-loading').forEach(btn => {
        btn.addEventListener('click', () => { showOverlay(); });
    });
    window.addEventListener('pageshow', hideOverlay);
    window.addEventListener('load', hideOverlay);
});
</script>
{% endblock %}